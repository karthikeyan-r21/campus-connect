<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- Font Awesome -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
      rel="stylesheet"
    />

    <!-- Quill CSS -->
    <link
      href="https://cdn.quilljs.com/1.3.7/quill.snow.css"
      rel="stylesheet"
    />

    <style>
      body {
        font-family: "Arial", sans-serif;
      }
      .create-post-container {
        max-width: 700px;
        margin: 50px auto;

        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        color: white;
      }
      .form-control,
      .ql-container {
        border-radius: 8px;
      }
      .ql-toolbar {
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
      }
      .ql-container {
        height: 300px;
        border-bottom-left-radius: 8px;
        border-bottom-right-radius: 8px;
      }
      .btn-publish {
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        color: white;
        transition: all 0.3s ease;
      }
      .btn-publish:hover {
        background-color: white;
        transform: translateY(-2px);
        color: #ff6934;
      }
      .file-input-wrapper {
        position: relative;
        overflow: hidden;
      }
      .file-input-wrapper input[type="file"] {
        font-size: 100px;
        position: absolute;
        left: 0;
        top: 0;
        opacity: 0;
      }
      .custom-file-label {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .banner {
        color: #ff6934;
      }
      .ql-toolbar.ql-snow {
        background-color: white;
      }

      label {
        color: #ff6934;
      }
      /* Make Quill-inserted images smaller and styled */
      .ql-editor img {
        max-width: 200px;
        max-height: 200px;
        width: 200px;
        height: 200px;
        object-fit: cover;
        border-radius: 8px;
        margin: 20px auto;
        display: block;
      }
    </style>
  </head>
  <body>
    <%- include('partials/header') %>
    <div class="container">
      <div class="create-post-container">
        <% if (message) { %>
        <div class="alert alert-info"><%= message %></div>
        <% } %>

        <form
          action="/create-post"
          method="POST"
          enctype="multipart/form-data"
          id="create-post-form"
        >
          <h1 class="mb-4 text-center banner">Create a New Post</h1>

          <!-- Post Title Input -->
          <div class="mb-3">
            <label for="post-title" class="form-label">Post Title</label>
            <input
              type="text"
              name="title"
              id="post-title"
              placeholder="Enter your post title"
              class="form-control form-control-lg"
              required
            />
          </div>

          <!-- Document Upload with Button -->
          <div class="mb-3">
            <label for="post-documents" class="form-label">Upload Documents</label>
            <div class="file-input-wrapper d-flex gap-2 align-items-center">
              <input
                type="file"
                name="documents"
                id="post-documents"
                accept=".pdf,.doc,.docx,.txt"
                class="form-control"
                multiple
              />
              <button
                type="button"
                class="btn btn-publish"
                onclick="handleDocumentUpload()"
              >
                <i class="fas fa-upload"></i> Upload
              </button>
              <span id="selected-file-names" class="ms-2 text-white" style="max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;"></span>
            </div>
          </div>

          <!-- Quill Editor -->
          <div class="mb-3">
            <label class="form-label">Post Content</label>
            <div id="editor-container"></div>
          </div>

          <!-- Hidden Input for Quill Content -->
          <input type="hidden" name="content" id="content-input" />

          <!-- Publish Button -->
          <div class="text-center">
            <button type="submit" class="btn btn-publish btn-lg mt-3">
              Publish Post
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Quill JS -->
    <script src="https://cdn.quilljs.com/1.3.7/quill.js"></script>

    <script>
      function handleDocumentUpload() {
        const input = document.getElementById("post-documents");
        input.click();

        input.onchange = async () => {
          const fileList = document.createElement("ul");
          fileList.className = "list-group mt-2";

          Array.from(input.files).forEach(async (file) => {
            const formData = new FormData();
            formData.append("document", file);

            try {
              const response = await fetch("/upload-document", {
                method: "POST",
                body: formData,
              });

              if (response.ok) {
                const data = await response.json();
                const li = document.createElement("li");
                li.className =
                  "list-group-item d-flex justify-content-between align-items-center bg-dark text-white";
                li.textContent = file.name;
                fileList.appendChild(li);

                const range = quill.getSelection();
                quill.insertText(
                  range.index,
                  `${file.name}`,
                  "link",
                  data.fileUrl
                );
              }
            } catch (error) {
              console.error("Upload failed: ", error);
            }
          });

          // Display file list below input
          const container = input.parentElement;
          const existingList = container.querySelector(".list-group");
          if (existingList) {
            container.removeChild(existingList);
          }
          container.appendChild(fileList);
        };
      }

      document.addEventListener("DOMContentLoaded", function () {
        window.quill = new Quill("#editor-container", {
          theme: "snow",
          placeholder: "Write your post content here...",
          modules: {
            toolbar: {
              container: [
                [{ header: [1, 2, false] }],
                ["bold", "italic", "underline"],
                ["image"],
                [{ list: "ordered" }, { list: "bullet" }],
              ],
              handlers: {
                image: function () {
                  const input = document.createElement("input");
                  input.setAttribute("type", "file");
                  input.setAttribute("accept", "image/*");
                  input.click();

                  input.onchange = async () => {
                    const file = input.files[0];
                    if (file) {
                      const formData = new FormData();
                      formData.append("image", file);

                      const response = await fetch("/upload-image", {
                        method: "POST",
                        body: formData,
                      });

                      if (response.ok) {
                        const { imageUrl } = await response.json();
                        const range = quill.getSelection(true);
                        quill.insertEmbed(range.index, "image", imageUrl);
                      }
                    }
                  };
                },
              },
            },
            clipboard: {
              matchVisual: false,
              allowed: {
                tags: ["img"],
              },
            },
          },
        });

        // Handle pasted images
        quill.on("paste", function (e) {
          if (e.clipboardData && e.clipboardData.items) {
            const items = e.clipboardData.items;
            for (let i = 0; i < items.length; i++) {
              if (items[i].type.indexOf("image") !== -1) {
                const blob = items[i].getAsFile();
                const formData = new FormData();
                formData.append("image", blob);

                fetch("/upload-image", {
                  method: "POST",
                  body: formData,
                })
                  .then((response) => response.json())
                  .then((data) => {
                    const range = quill.getSelection(true);
                    quill.insertEmbed(range.index, "image", data.imageUrl);
                  });
              }
            }
          }
        });

        // Form submission: Save Quill content to hidden input
        document.getElementById("create-post-form").onsubmit = function (e) {
          const content = window.quill.root.innerHTML.trim();
          if (!content || content === '<p><br></p>') {
            alert("Post content cannot be empty.");
            e.preventDefault();
            return false;
          }
          document.getElementById("content-input").value = content;
        };
      });

      // Show selected file names next to upload button
      const postDocumentsInput = document.getElementById('post-documents');
      const selectedFileNamesSpan = document.getElementById('selected-file-names');
      if (postDocumentsInput && selectedFileNamesSpan) {
        postDocumentsInput.addEventListener('change', function() {
          if (postDocumentsInput.files.length > 0) {
            const names = Array.from(postDocumentsInput.files).map(f => f.name).join(', ');
            selectedFileNamesSpan.textContent = names;
          } else {
            selectedFileNamesSpan.textContent = '';
          }
        });
      }
    </script>
  </body>
</html>
